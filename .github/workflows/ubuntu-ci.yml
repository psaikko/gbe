# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: ubuntu-ci
on:
  push:
    paths:
      - '.github/workflows/*'
      - 'src/**.cpp'
      - 'include/**.h'
      - 'test/*'
      - 'CMakeLists.txt'
jobs:
    build-library:
        runs-on: ubuntu-20.04
        container: psaikko/gbe-builder:ubuntu-20.04
        steps:
        - uses: actions/checkout@v3
        - name: Build static library
          run: |
            cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -S. -B./build
            make -C./build -j2 libgbe
        - name: Upload library artifact
          uses: actions/upload-artifact@v3
          with:
            name: libgbe.a
            path: ./build/libgbe.a
        - name: Build executable
          run: |
            make -C./build -j2 gbe
    run-test-roms:
        needs: build-library
        runs-on: ubuntu-20.04
        steps:
        - uses: actions/checkout@v3
        - uses: actions/download-artifact@v3
          with:
            name: libgbe.a
        - name: Get test ROMs submodule
          run: git submodule update --init gb-test-roms
        - name: Compile runner and run tests
          shell: bash
          run: |
            cd test
            g++ -I../include run_test_rom.cpp -o run_test_rom ../libgbe.a
            python test_runner.py
        - name: Test report
          uses: EnricoMi/publish-unit-test-result-action@v1
          with:
            files: "test/*.xml"
            comment_mode: off
            check_name: Test ROM results

